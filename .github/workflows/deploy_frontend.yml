name: Build and Deploy Frontend

on:
  push:
    branches: [dev, main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (dev | prd)'
        required: false
        default: ''

jobs:
  setup:
    name: Determine environment
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.set-env.outputs.env }}
      should_run: ${{ steps.set-env.outputs.should_run }}
    steps:
      - id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
            SHOULD_RUN=$( [[ -n "$ENV" ]] && echo "true" || echo "false" )
          elif [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            ENV="dev"
            SHOULD_RUN="true"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="prd"
            SHOULD_RUN="true"
          else
            SHOULD_RUN="false"
          fi
          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT

  deploy:
    name: Build and deploy to ${{ needs.setup.outputs.env }}
    needs: setup
    if: needs.setup.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v2

      - name: Login to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      - name: Build and Push Image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/dockerfile
          push: true
          tags: |
            ghcr.io/uc-captstone/away-game:${{ needs.setup.outputs.env }}-latest
            ghcr.io/uc-captstone/away-game:${{ needs.setup.outputs.env }}-${{ github.sha }}

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_DEV_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_DEV_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUB_ID }}

      - name: Retrieve Secrets from Key Vault
        uses: azure/CLI@v1
        with:
          inlineScript: |
            for secret in clerk-secret-key clerk-domain jwt-secret-key; do
              value=$(az keyvault secret show --name $secret --vault-name away-game-kv --query value -o tsv)
              echo "::add-mask::$value"
              var_name=$(echo "$secret" | tr '[:lower:]-' '[:upper:]_')
              echo "$var_name=$value" >> $GITHUB_ENV
            done

      - name: Configure App Settings
        uses: azure/appservice-settings@v1
        with:
          app-name: away-game-${{ needs.setup.outputs.env }}
          app-settings-json: |
            [
              {"name": "CLERK_SECRET_KEY", "value": "${{ env.CLERK_SECRET_KEY }}", "slotSetting": false},
              {"name": "CLERK_DOMAIN", "value": "${{ env.CLERK_DOMAIN }}", "slotSetting": false},
              {"name": "JWT_SECRET_KEY", "value": "${{ env.JWT_SECRET_KEY }}", "slotSetting": false}
            ]

      - name: Deploy to Azure
        uses: azure/webapps-deploy@v2
        with:
          app-name: away-game-${{ needs.setup.outputs.env }}
          slot-name: Production
          images: ghcr.io/uc-captstone/away-game:${{ needs.setup.outputs.env }}-${{ needs.setup.outputs.env == 'prd' && github.sha || 'latest' }}