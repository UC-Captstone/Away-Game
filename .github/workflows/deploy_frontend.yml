# Combined build & deploy workflow for dev (dev branch) and prd (main branch)
# Triggers on push to dev or main, and supports manual workflow_dispatch with an 'environment' input.
name: Build and deploy container app to Azure Web App - away-game (dev & prd)

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Optional: run for dev or prd (dev | prd). Leave empty to run nothing automatically.'
        required: false
        default: ''

jobs:
  build-and-deploy-dev:
    name: Build, push and deploy to away-game-dev
    runs-on: ubuntu-latest
    # Only run for pushes to the dev branch, or when manually dispatched with environment=dev
    if: >
      github.ref == 'refs/heads/dev'
      || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Debug environment variables
        run: env

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to container registry (dev)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor}}
          password: ${{ secrets.CR_PAT}}

      - name: Build and push container image to registry (dev)
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: |
            ghcr.io/uc-captstone/away-game:dev-latest
            ghcr.io/uc-captstone/away-game:dev-${{ github.sha }}
          file: ./frontend/dockerfile

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_DEV_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_DEV_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUB_ID }}

      - name: Get Clerk API token from Key Vault (dev)
        uses: azure/CLI@v1
        with:
          inlineScript: |
            CLERK_SECRET_KEY=$(az keyvault secret show --name clerk-secret-key --vault-name away-game-kv --query value -o tsv)
            echo "::add-mask::$CLERK_SECRET_KEY"
            echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY" >> $GITHUB_ENV

            CLERK_DOMAIN=$(az keyvault secret show --name clerk-domain --vault-name away-game-kv --query value -o tsv)
            echo "::add-mask::$CLERK_DOMAIN"
            echo "CLERK_DOMAIN=$CLERK_DOMAIN" >> $GITHUB_ENV

            JWT_SECRET_KEY=$(az keyvault secret show --name jwt-secret-key --vault-name away-game-kv --query value -o tsv)
            echo "::add-mask::$JWT_SECRET_KEY"
            echo "JWT_SECRET_KEY=$JWT_SECRET_KEY" >> $GITHUB_ENV

      - name: Configure Web App Settings (dev)
        uses: azure/appservice-settings@v1
        with:
          app-name: 'away-game-dev'
          app-settings-json: |
            [
              {
                "name": "CLERK_SECRET_KEY",
                "value": "${{ env.CLERK_SECRET_KEY }}",
                "slotSetting": false
              },
              {
                "name": "CLERK_DOMAIN",
                "value": "${{ env.CLERK_DOMAIN }}",
                "slotSetting": false
              },
              {
                "name": "JWT_SECRET_KEY",
                "value": "${{ env.JWT_SECRET_KEY }}",
                "slotSetting": false
              }
            ]

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'away-game-dev'
          slot-name: 'Production'
          images: 'ghcr.io/uc-captstone/away-game:dev-latest'

  build-and-deploy-prd:
    name: Build, push and deploy to away-game-prd
    runs-on: ubuntu-latest
    # Only run for pushes to the main branch, or when manually dispatched with environment=prd
    if: >
      github.ref == 'refs/heads/main'
      || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prd')
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to container registry (prd)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor}}
          password: ${{ secrets.CR_PAT}}

      - name: Build and push container image to registry (prd)
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: |
            ghcr.io/uc-captstone/away-game:prd-latest
            ghcr.io/uc-captstone/away-game:prd-${{ github.sha }}
          file: ./frontend/dockerfile

      - name: Login to Azure (prd)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_DEV_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_DEV_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUB_ID }}

      - name: Get Clerk API token from Key Vault (prd)
        uses: azure/CLI@v1
        with:
          inlineScript: |
            CLERK_SECRET_KEY=$(az keyvault secret show --name clerk-secret-key --vault-name away-game-kv --query value -o tsv)
            CLERK_DOMAIN=$(az keyvault secret show --name clerk-domain --vault-name away-game-kv --query value -o tsv)
            JWT_SECRET_KEY=$(az keyvault secret show --name jwt-secret-key --vault-name away-game-kv --query value -o tsv)

            echo "::add-mask::$CLERK_SECRET_KEY"
            echo "::add-mask::$CLERK_DOMAIN"
            echo "::add-mask::$JWT_SECRET_KEY"

            echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY" >> $GITHUB_ENV
            echo "CLERK_DOMAIN=$CLERK_DOMAIN" >> $GITHUB_ENV
            echo "JWT_SECRET_KEY=$JWT_SECRET_KEY" >> $GITHUB_ENV

      - name: Configure Web App Settings (prd)
        uses: azure/appservice-settings@v1
        with:
          app-name: 'away-game-prd'
          app-settings-json: |
            [
              {
                "name": "CLERK_SECRET_KEY",
                "value": "${{ env.CLERK_SECRET_KEY }}",
                "slotSetting": false
              },
              {
                "name": "CLERK_DOMAIN",
                "value": "${{ env.CLERK_DOMAIN }}",
                "slotSetting": false
              },
              {
                "name": "JWT_SECRET_KEY",
                "value": "${{ env.JWT_SECRET_KEY }}",
                "slotSetting": false
              }
            ]

      - name: Deploy to Azure Web App (prd)
        id: deploy-to-webapp-prd
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'away-game-prd'
          slot-name: 'Production'
          images: 'ghcr.io/uc-captstone/away-game:prd-${{ github.sha }}'